name: VoiceBeat Deploy

on:
  push:
    branches: [main] # change if you deploy a different branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VM (pull + write env + install deps + restart)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -euo pipefail

            # Repo root on VM (adjust if yours differs)
            REPO_ROOT="/opt/voicebeat/composium"
            APP_DIR="$REPO_ROOT/voicebeat"

            cd "$REPO_ROOT"
            git fetch origin
            git checkout main
            git reset --hard origin/main

            # Write .env exactly where systemd expects it
            cat > "$REPO_ROOT/.env" <<EOF
            SMALLEST_API_KEY=${{ secrets.SMALLEST_API_KEY }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            PULSE_MODEL=${{ secrets.PULSE_MODEL }}
            PULSE_LANGUAGE=${{ secrets.PULSE_LANGUAGE }}
            TTS_VOICE_ID=${{ secrets.TTS_VOICE_ID }}
            TTS_SAMPLE_RATE=${{ secrets.TTS_SAMPLE_RATE }}
            SAMPLES_DIR=./samples
            OUTPUT_DIR=./output
            DEFAULT_BPM=120
            OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}
            SUBAGENT_MODEL=${{ secrets.SUBAGENT_MODEL }}
            EOF

            chmod 600 "$REPO_ROOT/.env"
            chown ubi:ubi "$REPO_ROOT/.env"

            # Ensure folders exist (since you reference them)
            mkdir -p "$APP_DIR/samples" "$APP_DIR/output"

            # Install/refresh deps so new requirements show up
            cd "$APP_DIR"
            . .venv/bin/activate

            # Upgrade pip and essential build tools first
            pip install --upgrade pip setuptools wheel

            # Install packages in stages to handle build issues
            echo "Installing core dependencies..."
            pip install --only-binary=numpy "numpy==1.24.3" || {
              echo "Installing numpy from source as fallback..."
              pip install --upgrade setuptools wheel cython
              pip install "numpy==1.24.3"
            }

            # Install PyTorch CPU version specifically for server deployment
            echo "Installing PyTorch..."
            pip install torch torchaudio --index-url https://download.pytorch.org/whl/cpu

            # Install other core packages
            echo "Installing remaining packages..."
            pip install fastapi uvicorn[standard] python-multipart pydantic pydantic-settings
            pip install librosa soundfile pydub httpx openai python-dotenv aiofiles
            pip install uuid6 midiutil pytest

            # Install rvc-python last as it has complex dependencies
            echo "Installing rvc-python..."
            pip install rvc-python || {
              echo "rvc-python installation failed, trying with --no-deps..."
              pip install rvc-python --no-deps
            }

            sudo systemctl daemon-reload
            sudo systemctl restart voicebeat.service
            sudo systemctl --no-pager --full status voicebeat.service | sed -n '1,25p'
            curl -fsS http://localhost:8000/health || true
