name: VoiceBeat Deploy

on:
  push:
    branches: [composium-bridge] # change if you deploy a different branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VM (pull + write env + install deps + restart)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -euo pipefail

            # Repo root on VM (adjust if yours differs)
            REPO_ROOT="/opt/voicebeat/composium"
            APP_DIR="$REPO_ROOT/voicebeat"

            cd "$REPO_ROOT"
            git fetch origin
            git checkout composium-bridge
            git reset --hard origin/composium-bridge

            # Write .env exactly where systemd expects it
            cat > "$REPO_ROOT/.env" <<EOF
            SMALLEST_API_KEY=${{ secrets.SMALLEST_API_KEY }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            PULSE_MODEL=${{ secrets.PULSE_MODEL }}
            PULSE_LANGUAGE=${{ secrets.PULSE_LANGUAGE }}
            TTS_VOICE_ID=${{ secrets.TTS_VOICE_ID }}
            TTS_SAMPLE_RATE=${{ secrets.TTS_SAMPLE_RATE }}
            R2_ACCOUNT_ID=${{ secrets.R2_ACCOUNT_ID }}
            R2_ACCESS_KEY_ID=${{ secrets.R2_ACCESS_KEY_ID }}
            R2_SECRET_ACCESS_KEY=${{ secrets.R2_SECRET_ACCESS_KEY }}
            R2_BUCKET_NAME=${{ secrets.R2_BUCKET_NAME }}

            SAMPLES_DIR=./samples
            OUTPUT_DIR=./output
            DEFAULT_BPM=120
            OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}
            SUBAGENT_MODEL=${{ secrets.SUBAGENT_MODEL }}
            EOF

            chmod 600 "$REPO_ROOT/.env"
            chown ubi:ubi "$REPO_ROOT/.env"

            # Ensure folders exist (since you reference them)
            mkdir -p "$APP_DIR/samples" "$APP_DIR/output"

            # Install/refresh deps so new requirements show up
            cd "$APP_DIR"
            . .venv/bin/activate
            pip install -r requirements.txt

            sudo systemctl daemon-reload
            sudo systemctl restart voicebeat.service
            sudo systemctl --no-pager --full status voicebeat.service | sed -n '1,25p'
            curl -fsS http://localhost:8000/health || true
